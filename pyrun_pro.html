
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PyRun Pro — Personal Python Web IDE</title>
  <!-- CodeMirror 5 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material-darker.min.css">
  <style>
    :root{--bg:#0b1220;--panel:#071029;--muted:#9aa8b2;--accent:#06b6d4;--success:#16a34a}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071124 0%, #07192b 100%);font-family:Inter,Segoe UI,Arial,sans-serif;color:#e6eef6}
    header{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;gap:12px;align-items:center}
    .brand{font-weight:700;font-size:16px;color:var(--accent)}
    .container{display:grid;grid-template-columns:1fr 420px;gap:12px;padding:12px;height:calc(100% - 64px)}
    .editor-panel{background:var(--panel);padding:10px;border-radius:8px;display:flex;flex-direction:column;height:100%}
    #editorWrapper{flex:1;border-radius:6px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
    .toolbar{display:flex;gap:8px;margin-bottom:8px}
    button{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.03);color:#e6eef6;padding:8px 10px;border-radius:6px;cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),#3dd5c6);color:#052023;font-weight:700}
    .side-panel{background:var(--panel);padding:12px;border-radius:8px;display:flex;flex-direction:column;height:100%}
    .output{background:#051220;border-radius:6px;padding:10px;flex:1;overflow:auto;font-family:ui-monospace,monospace;font-size:13px}
    .section{margin-bottom:10px}
    label{font-size:12px;color:var(--muted)}
    select,input[type=number]{width:100%;padding:8px;margin-top:6px;border-radius:6px;background:#071029;border:1px solid rgba(255,255,255,0.02);color:#e6eef6}
    .small{font-size:12px;color:var(--muted)}
    footer{padding:8px 14px;border-top:1px solid rgba(255,255,255,0.03);font-size:13px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .row{display:flex;gap:8px;align-items:center}
    .hint{font-size:12px;color:#9fbccd}
    a.link{color:var(--accent);text-decoration:none}
    .file-actions{display:flex;gap:6px}
    .tabs{display:flex;gap:6px;margin-bottom:8px}
    .tab{padding:6px 10px;border-radius:6px;background:rgba(255,255,255,0.02);cursor:pointer}
    .tab.active{background:linear-gradient(90deg,#0dd6e0,#3dd5c6);color:#052023;font-weight:700}
    .flex-row{display:flex;gap:8px;align-items:center}
    @media(max-width:1000px){.container{grid-template-columns:1fr;grid-auto-rows:1fr}.side-panel{height:360px}}
  </style>
</head>
<body>
  <header>
    <div class="brand">PyRun Pro</div>
    <div class="hint">Advanced Personal Web IDE — runs Python in your browser via Pyodide • Save, tabs, clipboard, packages, GitHub Pages ready</div>
  </header>

  <div class="container">
    <div class="editor-panel">
      <div class="toolbar">
        <button id="runBtn" class="primary">Run ▶</button>
        <button id="stopBtn">Stop</button>
        <button id="clearOutput">Clear Output</button>
        <button id="formatBtn">Format</button>
        <div style="flex:1"></div>
        <div class="file-actions">
          <button id="newTab">New Tab</button>
          <button id="saveFile">Save</button>
          <button id="downloadAll">Download All</button>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>
      <div id="editorWrapper"><textarea id="editor" spellcheck="false"></textarea></div>

      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <label class="small">Execution timeout (s)</label>
        <input id="timeout" type="number" value="20" min="1" style="width:90px" />
        <label class="small">Pyodide v</label>
        <select id="pyodideVersion" style="width:160px">
          <option value="0.23.4">0.23.4</option>
          <option value="0.22.1">0.22.1</option>
        </select>
      </div>
    </div>

    <div class="side-panel">
      <div class="section">
        <label>Output</label>
        <div id="output" class="output">Output will appear here.</div>
      </div>

      <div class="section">
        <label>Packages (micropip)</label>
        <input id="pkgName" placeholder="e.g. numpy pandas rich" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="installBtn">Install</button>
          <button id="listPkgs">List</button>
          <button id="clearPkgs">Clear env</button>
        </div>
        <div class="small" style="margin-top:6px;color:var(--muted)">Note: Some packages may not be available. See Pyodide docs.</div>
      </div>

      <div class="section">
        <label>Examples</label>
        <select id="examples">
          <option value="">-- Choose example --</option>
          <option value="numpy">NumPy demo</option>
          <option value="pandas">Pandas demo</option>
          <option value="plot">Matplotlib demo</option>
          <option value="diceware">Diceware passphrase</option>
        </select>
        <button id="loadExample">Load</button>
      </div>

      <div class="section">
        <label>Files</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button id="uploadFile">Upload .py</button>
          <button id="openFromURL">Open URL</button>
        </div>
      </div>

      <div class="section">
        <label>Help & Notes</label>
        <div class="small">This IDE runs entirely in your browser. Good for intermediate Python, learning security tooling, and personal projects. For heavy compute, use Colab or a local Python install.</div>
      </div>
    </div>
  </div>

  <footer>
    <div>PyRun Pro — Save this file and open in Chrome/Edge/Firefox • Use GitHub Pages to host</div>
    <div class="small">Created for educational use</div>
  </footer>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>
  <script>
  // Basic tab & editor setup
  let tabs = [];
  let currentTab = null;
  const tabsEl = document.getElementById('tabs');
  const editorTextarea = document.getElementById('editor');
  let cm = CodeMirror.fromTextArea(editorTextarea, {
    mode: 'python',
    theme: 'material-darker',
    lineNumbers: true,
    matchBrackets: true,
    indentUnit: 4,
    tabSize: 4
  });

  function createTab(name, content='') {
    const id = 'tab_'+Date.now();
    tabs.push({id,name,content});
    renderTabs();
    switchTab(id);
  }
  function renderTabs() {
    tabsEl.innerHTML='';
    tabs.forEach(t=>{
      const d = document.createElement('div');
      d.className='tab' + (t.id===currentTab?' active':'');
      d.textContent = t.name;
      d.onclick = ()=> switchTab(t.id);
      tabsEl.appendChild(d);
    });
  }
  function switchTab(id) {
    // store current content
    if(currentTab){
      const idx = tabs.findIndex(x=>x.id===currentTab);
      if(idx>=0) tabs[idx].content = cm.getValue();
    }
    currentTab = id;
    const tab = tabs.find(x=>x.id===id);
    if(tab) cm.setValue(tab.content||'');
    renderTabs();
  }
  function saveCurrentTab() {
    if(!currentTab) return null;
    const tab = tabs.find(x=>x.id===currentTab);
    if(tab){ tab.content = cm.getValue(); return tab; }
    return null;
  }

  // initialize with a sample tab
  createTab('main.py', `# PyRun Pro - main.py\\nprint('Hello from PyRun Pro!')\\n`);
  createTab('utils.py', `# utils\\ndef add(a,b):\\n    return a+b\\n`);

  // UI bindings
  document.getElementById('newTab').onclick = ()=> createTab('untitled.py','');
  document.getElementById('saveFile').onclick = ()=>{
    const t = saveCurrentTab();
    if(!t){ alert('No tab'); return; }
    const blob = new Blob([t.content], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = t.name;
    a.click();
    URL.revokeObjectURL(a.href);
  };
  document.getElementById('downloadAll').onclick = ()=>{
    saveCurrentTab();
    const zipParts = [];
    // simple multiple-download via creating a single zip is complex client-side;
    // instead create a combined file
    let combined = '';
    tabs.forEach(t=> combined += `# FILE: ${t.name}\\n` + t.content + '\\n\\n');
    const blob = new Blob([combined], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'pyrun_project.txt';
    a.click();
    URL.revokeObjectURL(a.href);
  };

  document.getElementById('uploadFile').onclick = ()=>{
    const inp = document.createElement('input');
    inp.type='file'; inp.accept='.py,text/plain';
    inp.onchange = (e)=> {
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ()=> createTab(f.name, r.result);
      r.readAsText(f);
    };
    inp.click();
  };

  // Open from URL
  document.getElementById('openFromURL').onclick = async ()=>{
    const url = prompt('Enter raw file URL (https://):');
    if(!url) return;
    try{
      const res = await fetch(url);
      const txt = await res.text();
      createTab('from_url.py', txt);
    }catch(e){ alert('Failed to load: '+e); }
  };

  // Examples
  document.getElementById('loadExample').onclick = ()=>{
    const v = document.getElementById('examples').value;
    if(v==='numpy'){
      createTab('numpy_demo.py', "import numpy as np\\narr=np.arange(12).reshape(3,4)\\nprint(arr)\\n");
    }else if(v==='pandas'){
      createTab('pandas_demo.py', "import pandas as pd\\ndf=pd.DataFrame({'a':[1,2],'b':[3,4]})\\nprint(df)\\n");
    }else if(v==='plot'){
      createTab('plot_demo.py', "import matplotlib.pyplot as plt\\nimport numpy as np\\nx=np.linspace(0,6.28,200)\\nplt.plot(x,np.sin(x))\\nplt.savefig('plot.png')\\nprint('plot.png saved to virtual FS')\\n");
    }else if(v==='diceware'){
      createTab('diceware.py', "import secrets,sys\\nwords=['correct','horse','battery','staple','alpha','bravo','charlie']\\nprint(' '.join(secrets.choice(words) for _ in range(6)))\\n");
    }
  };

  // Output helpers
  const outputEl = document.getElementById('output');
  function appendOutput(s){ const p=document.createElement('pre'); p.style.margin='6px 0'; p.textContent=s; outputEl.appendChild(p); outputEl.scrollTop=outputEl.scrollHeight; }
  function setOutput(s){ outputEl.innerText = s; }

  // Pyodide loader & runner
  let pyodide = null;
  let pyodideReady = false;
  async function loadPyodideVersion(version){
    if(pyodide) return;
    setOutput('Loading Pyodide v'+version+' ... (first load may take 5-20s)');
    const url = `https://cdn.jsdelivr.net/pyodide/v${version}/full/pyodide.js`;
    await import(url);
    pyodide = await loadPyodide({indexURL: `https://cdn.jsdelivr.net/pyodide/v${version}/full/`});
    pyodideReady = true;
    appendOutput('Pyodide loaded.');
  }
  loadPyodideVersion(document.getElementById('pyodideVersion').value).catch(e=>appendOutput('Load error: '+e));

  // Run / stop controls
  let runningPromise = null;
  document.getElementById('runBtn').onclick = async ()=>{
    if(!pyodideReady){ appendOutput('Pyodide not ready'); return; }
    saveCurrentTab();
    const code = tabs.find(t=>t.id===currentTab).content;
    setOutput('Executing...');
    try{
      let stdout=''; let stderr='';
      pyodide.setStdout({batched: s => { stdout += s; }});
      pyodide.setStderr({batched: s => { stderr += s; }});
      const to = Number(document.getElementById('timeout').value) || 20;
      runningPromise = pyodide.runPythonAsync(code);
      const res = await Promise.race([runningPromise, new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout')), to*1000))]);
      let out = '';
      if(stdout) out += '--- stdout ---\\n'+stdout;
      if(stderr) out += '--- stderr ---\\n'+stderr;
      if(res !== undefined) out += '\\n--- result ---\\n'+String(res);
      setOutput(out || 'Finished (no output)');
    }catch(e){
      appendOutput('Error: '+e);
    }finally{
      try{ pyodide.setStdout({batched: s => appendOutput(s)}); }catch(e){}
      try{ pyodide.setStderr({batched: s => appendOutput(s)}); }catch(e){}
      runningPromise = null;
    }
  };
  document.getElementById('stopBtn').onclick = ()=>{
    if(runningPromise && typeof runningPromise.cancel === 'function'){ runningPromise.cancel(); appendOutput('Execution cancelled'); }
    else appendOutput('Stop not supported for this run (will time out).');
  };

  document.getElementById('clearOutput').onclick = ()=> setOutput('');
  document.getElementById('pyodideVersion').onchange = (e)=> location.reload();

  // Install packages
  document.getElementById('installBtn').onclick = async ()=>{
    if(!pyodideReady){ appendOutput('Pyodide not ready'); return; }
    const names = document.getElementById('pkgName').value.trim();
    if(!names){ appendOutput('Enter package names'); return; }
    appendOutput('Installing: '+names);
    try{
      await pyodide.loadPackage('micropip');
      const micropip = pyodide.pyimport('micropip');
      const pkgs = names.split(/\s+/);
      for(const p of pkgs){
        appendOutput('Installing '+p+' ...');
        await micropip.install(p);
        appendOutput('Installed '+p);
      }
    }catch(e){ appendOutput('Install error: '+e); }
  };

  document.getElementById('listPkgs').onclick = ()=>{
    try{
      const loaded = pyodide && pyodide.loadedPackages ? Object.keys(pyodide.loadedPackages) : [];
      appendOutput('Loaded: '+ (loaded.length?loaded.join(', '):'<none>'));
    }catch(e){ appendOutput('Error: '+e); }
  };

  document.getElementById('clearPkgs').onclick = ()=>{
    appendOutput('Reloading page to clear environment...'); setTimeout(()=>location.reload(),600);
  };

  // Format using black if available via micropip
  document.getElementById('formatBtn').onclick = async ()=>{
    if(!pyodideReady){ appendOutput('Pyodide not ready'); return; }
    appendOutput('Formatting (attempting to install black)...');
    try{
      await pyodide.loadPackage('micropip');
      const micropip = pyodide.pyimport('micropip');
      try{ await micropip.install('black'); }catch(e){ appendOutput('Black install failed: '+e); }
      const black = pyodide.pyimport('black');
      const src = cm.getValue();
      const formatted = black.format_str(src, {mode: black.Mode()});
      cm.setValue(formatted);
      appendOutput('Formatted.');
    }catch(e){ appendOutput('Format error: '+e); }
  };

  // Save all tabs to a combined project file
  // Clipboard copy of current content
  async function copyToClipboard(text){
    try{ await navigator.clipboard.writeText(text); appendOutput('Copied current tab to clipboard'); }
    catch(e){ appendOutput('Clipboard failed: '+e); }
  }

  // Save current tab content to clipboard via menu
  document.getElementById('saveFile').addEventListener('contextmenu', (e)=>{ e.preventDefault(); saveCurrentTab(); copyToClipboard(tabs.find(t=>t.id===currentTab).content); });

  // simple keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key==='s'){ e.preventDefault(); document.getElementById('saveFile').click(); }
    if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); document.getElementById('runBtn').click(); }
  });

  // On unload, warn if unsaved changes
  window.addEventListener('beforeunload', (e)=>{
    // simple check: if any tab content differs from default (always true) skip; we won't block unload here
  });

  </script>
</body>
</html>
